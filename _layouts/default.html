{% assign current_lang = site.active_lang | default: page.lang | default: site.default_lang %}
<!DOCTYPE html>
<html lang="{{ current_lang | escape }}">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% if page.title %}{{ page.title }} - {{ site.title }}{% else %}{{ site.title }}{% endif %}</title>
  <meta name="description"
    content="{% if page.description %}{{ page.description }}{% else %}{{ site.description }}{% endif %}">
  <link rel="stylesheet" href="{{ '/assets/css/main.css' | relative_url }}">
  <script type="text/javascript" data-width="auto" data-color="mono"
    src="https://dbcls.rois.ac.jp/DBCLS-common-header-footer/common-header-and-footer/script/common-header-and-footer.js"
    style="display: block" id="common-header-and-footer__script"></script>
</head>

<body{% if page.pageId %} data-page-id="{{ page.pageId }}" {% endif %}{% if page.parentPageId %}
  data-parent-page-id="{{ page.parentPageId }}" {% endif %}>
  {% assign canonical_path = page.permalink | default: page.url | default: '/' %}
  {% if canonical_path == '' %}
  {% assign canonical_path = '/' %}
  {% endif %}
  {% assign first_char = canonical_path | slice: 0, 1 %}
  {% unless first_char == '/' %}
  {% assign canonical_path = '/' | append: canonical_path %}
  {% endunless %}
  {% if current_lang != site.default_lang %}
  {% assign lang_prefix = '/' | append: current_lang %}
  {% assign lang_prefix_with_slash = lang_prefix | append: '/' %}
  {% assign lang_prefix_length = lang_prefix_with_slash | size %}
  {% assign path_prefix = canonical_path | slice: 0, lang_prefix_length %}
  {% if canonical_path == lang_prefix %}
  {% assign canonical_path = '/' %}
  {% elsif path_prefix == lang_prefix_with_slash %}
  {% assign canonical_path = canonical_path | replace_first: lang_prefix_with_slash, '/' %}
  {% endif %}
  {% endif %}
  {% assign counterpart_lang = '' %}
  {% assign counterpart_href = '' %}
  {% if page.permalink_lang %}
  {% for lang_code in site.languages %}
  {% if lang_code == current_lang %}
  {% continue %}
  {% endif %}
  {% assign canonical_lang_path = page.permalink_lang[lang_code] | default: '/' %}
  {% assign lang_href = canonical_lang_path %}
  {% if lang_code != site.default_lang %}
  {% if canonical_lang_path == '/' %}
  {% assign lang_href = '/' | append: lang_code | append: '/' %}
  {% else %}
  {% assign lang_href = '/' | append: lang_code | append: canonical_lang_path %}
  {% endif %}
  {% endif %}
  {% assign counterpart_lang = lang_code %}
  {% assign lang_href_clean = lang_href | strip %}
  {% assign counterpart_href = lang_href_clean | replace: '//', '/' %}
  {% break %}
  {% endfor %}
  {% endif %}
  <aside class="global-navigation">
    <div class="background"></div>
    <div class="inner">
      <h1>
        <a href="{{ '/' | relative_url }}">
          <img src="{{ '/assets/images/logo.svg' | relative_url }}" alt="RDF Portal Logo">
          <span>RDF<br>Portal</span>
        </a>
      </h1>
      <ul class="stats">
        <li><span>{{ site.data.datasets | size }}</span><span>RDF dataset</span></li>
        {% assign total_triples = 0 %}
        {% assign datasets = site.data.datasets | default: empty %}
        {% for d in datasets %}
        {% assign t = d.statistics.number_of_triples | default: 0 %}
        {% assign total_triples = total_triples | plus: t %}
        {% endfor %}
        {% comment %} Format into million/billion/trillion with one decimal when appropriate {% endcomment %}
        {% if total_triples >= 1000000000000 %}
        {% assign unit_div10 = 100000000000 %}
        {% assign scaled10 = total_triples | divided_by: unit_div10 %}
        {% assign intpart = scaled10 | divided_by: 10 %}
        {% assign dec = scaled10 | modulo: 10 %}
        {% if dec == 0 %}
        {% assign display = intpart %}
        {% else %}
        {% assign display = intpart | append: '.' | append: dec %}
        {% endif %}
        <li><span>{{ display }}</span><span>trillion triples</span></li>
        {% elsif total_triples >= 1000000000 %}
        {% assign unit_div10 = 100000000 %}
        {% assign scaled10 = total_triples | divided_by: unit_div10 %}
        {% assign intpart = scaled10 | divided_by: 10 %}
        {% assign dec = scaled10 | modulo: 10 %}
        {% if dec == 0 %}
        {% assign display = intpart %}
        {% else %}
        {% assign display = intpart | append: '.' | append: dec %}
        {% endif %}
        <li><span>{{ display }}</span><span>billion triples</span></li>
        {% elsif total_triples >= 1000000 %}
        {% assign unit_div10 = 100000 %}
        {% assign scaled10 = total_triples | divided_by: unit_div10 %}
        {% assign intpart = scaled10 | divided_by: 10 %}
        {% assign dec = scaled10 | modulo: 10 %}
        {% if dec == 0 %}
        {% assign display = intpart %}
        {% else %}
        {% assign display = intpart | append: '.' | append: dec %}
        {% endif %}
        <li><span>{{ display }}</span><span>million triples</span></li>
        {% else %}
        <li><span>{{ total_triples | default: 0 }}</span><span>triples</span></li>
        {% endif %}
      </ul>
      {% include nav.html %}
      <div class="space"></div>
      <div class="bottom">
        <p>© {{ site.time | date: "%Y" }} RDF Portal</p>
        <p><a href="{{ '/site-policy/' | relative_url }}">Site Policy</a></p>
        <span class="spacer"></span>
        {% comment %} Determine counterpart language and URL {% endcomment %}
        {% assign active_lang = site.active_lang | default: site.default_lang %}
        {% assign counterpart_lang = "en" %}
        {% if active_lang == "en" %}
        {% assign counterpart_lang = "ja" %}
        {% endif %}

        {% assign final_baseurl = site.baseurl %}
        {% if active_lang != site.default_lang %}
        {% assign lang_suffix = "/" | append: active_lang %}
        {% if final_baseurl contains lang_suffix %}
        {% assign final_baseurl = final_baseurl | remove: lang_suffix %}
        {% endif %}
        {% endif %}

        {% assign target_path = page.url %}
        {% if active_lang == "en" %}
        {% assign target_path = "/" | append: counterpart_lang | append: page.url %}
        {% assign target_path = target_path | replace: "//", "/" %}
        {% else %}
        {% assign lang_prefix_slash = "/" | append: active_lang | append: "/" %}
        {% assign lang_prefix_exact = "/" | append: active_lang %}

        {% if page.url contains lang_prefix_slash %}
        {% assign target_path = page.url | replace_first: lang_prefix_slash, "/" %}
        {% elsif page.url == lang_prefix_exact %}
        {% assign target_path = "/" %}
        {% endif %}
        {% endif %}

        {% assign site_host = site.url | remove: "http:" | remove: "https:" %}
        {% assign final_url = site_host | append: final_baseurl | append: target_path %}

        {% if counterpart_lang == "ja" %}
        {% assign counterpart_label = "日本語" %}
        {% else %}
        {% assign counterpart_label = "English" %}
        {% endif %}

        <div data-current-lang="{{ active_lang }}">
          <a href="{{ final_url }}" aria-label="Change language">
            {{ counterpart_label }}
          </a>
        </div>
      </div>
  </aside>

  <main>
    {{ content }}
  </main>

  <!-- モバイルメニュー関連のJSは削除済み -->

  <!-- ベースURLをJavaScriptで利用可能にする（全ページ共通） -->
  <script>
    {% assign my_base = site.baseurl %}
    {% if site.active_lang != site.default_lang %}
    {% assign my_base = my_base | append: "/" | append: site.active_lang %}
    {% endif %}
    window.SITE_BASE_URL = '{{ my_base }}';
    window.SITE_BASE_URL_ROOT = '{{ site.config.baseurl | default: site.baseurl }}';

    // URLパラメータ font=roman などがあれば body に data-font="roman" を付与する
    (function () {
      try {
        var params = new URLSearchParams(window.location.search || '');
        var f = params.get('font');
        if (f) {
          // 簡易サニタイズ（英数字と _- のみ許可、小文字化）
          var safe = String(f).toLowerCase().replace(/[^a-z0-9_-]/g, '');
          if (safe && document && document.body) document.body.setAttribute('data-font', safe);
        }
      } catch (e) {
        /* noop */
      }
    })();

    (function () {
      try {
        var switcherDiv = document.querySelector('.global-navigation .bottom div[data-current-lang]');
        var switcher = switcherDiv ? switcherDiv.querySelector('a') : null;
        if (!switcher || !switcherDiv) return;

        // Perform existence check only for News/Logs (or generally if safety needed)
        // For performance, we can skip check for known static pages if desired, but user asked for News case.
        // Let's check for all auto-generated links to be safe.

        var targetUrl = switcher.getAttribute('href');
        if (!targetUrl) return;

        // If it looks like an absolute URL on same domain or relative
        // We can check it. (Cross-origin might fail CORS, but here it's same domain)

        // Hide by default if we are unsure? 
        // User want "No button".
        // Let's set initial style to hidden or check async.
        // To avoid layout shift, maybe we keep it but disable click?
        // User said "English Button not shown" (1. English ボタンを出さない).

        // We will hide it initially via CSS or logic if we want to be strict,
        // but simple way: Check async, then remove if 404.

        // However, for standard pages (About, Access), we know they exist.
        // Checking everything might incur unnecessary network requests.
        // Maybe check if path contains /news/ or /logs/?
        var checkNeeded = /\/(news|logs)\//.test(targetUrl) || /\/(news|logs)\//.test(window.location.pathname);

        if (checkNeeded) {
          // Optimistic: Keep shown. If 404, hide.
          fetch(targetUrl, { method: 'HEAD' })
            .then(function (res) {
              if (!res.ok) {
                switcherDiv.style.display = 'none';
              }
            })
            .catch(function (e) {
              // Network error or other issue -> hide to be safe? Or ignore?
              // Ignore (keep shown) or Hide?
              // Safer to Hide if we can't verify 
              switcherDiv.style.display = 'none';
            });
        }
      } catch (e) {
        console.error('Lang switcher check error', e);
      }
    })();
  </script>
  </body>

</html>